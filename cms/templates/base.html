## coding=utf-8
<%namespace name='static' file='static_content.html'/>
<%!
import hashlib
import hmac
from django.utils.translation import ugettext as _
from openedx.core.lib.js_utils import (
    escape_json_dumps, escape_js_string
)
%>
<!doctype html>
<!--[if lte IE 9]><html class="ie9 lte9" lang="${LANGUAGE_CODE}"><![endif]-->
<!--[if !IE]><<!--><html lang="${LANGUAGE_CODE}"><!--<![endif]-->
  <head dir="${static.dir_rtl()}">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>
        <%block name="title"></%block> |
        % if context_course:
        <% ctx_loc = context_course.location %>
        ${context_course.display_name_with_default | h} |
        % elif context_library:
        ${context_library.display_name_with_default | h} |
        % endif
        ${settings.STUDIO_NAME}
    </title>

    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="path_prefix" content="${EDX_ROOT_URL}">

    <%static:css group='style-vendor'/>
    <%static:css group='style-vendor-tinymce-content'/>
    <%static:css group='style-vendor-tinymce-skin'/>
    <%static:css group='style-main'/>

    <%include file="widgets/segment-io.html" />

    <%block name="header_extras"></%block>
  </head>

  <body class="${static.dir_rtl()} <%block name='bodyclass'></%block> lang_${LANGUAGE_CODE}">
    <% is_anonymous = user.is_anonymous() %>

    % if not is_anonymous:

        <% testdrive_expiration_enforced = settings.ENFORCE_TESTDRIVE_EXPIRATION %>
        <% testdrive_expired = user.profile.is_testdrive_expired() %>
        <% days_til_testdrive_expires = user.profile.days_til_testdrive_expires() %>


        % if testdrive_expiration_enforced:
            % if testdrive_expired:
            <span style="position: absolute; top: 0; left: 0; padding: 15px; font-size: 14px; background-color: #e74c3c; display: block; width: 100%; color: #fff; font-family: sans-serif;">Your Appsembler Open edX Test Drive has <strong>expired!</strong> Please <a href="http://www.appsembler.com/contact/" style="font-weight:bolder; color: #fff;">let us know about your experience or if you want to extend your Test Drive.</a>.</span><span style="display: block; height: 46px; width: 100%;"></span>
            % else:
            <span style="padding: 15px; font-size: 14px; background-color: #0090c1; display: block; width: 100%; color: #fff; font-family: sans-serif;">Your Appsembler Open edX Test Drive <strong>expires</strong> in: <strong>${days_til_testdrive_expires}</strong> days.</span>
            % endif
        % endif

        % endif

    <%block name="view_notes"></%block>

    <a class="nav-skip" href="#content">${_("Skip to main content")}</a>

    <script type="text/javascript">
      window.baseUrl = "${escape_js_string(settings.STATIC_URL) | n}";
      var require = {baseUrl: window.baseUrl};
    </script>
    <script type="text/javascript" src="${static.url("js/vendor/require.js")}"></script>
    <script type="text/javascript" src="${static.url("cms/js/require-config.js")}"></script>

    <!-- view -->
    <div class="wrapper wrapper-view" dir="${static.dir_rtl()}">
        <% online_help_token = self.online_help_token() if hasattr(self, 'online_help_token') else None %>
        <%include file="widgets/header.html" args="online_help_token=online_help_token" />

      <div id="page-alert">
      <%block name="page_alert"></%block>
      </div>

      <div id="content">
      <%block name="content"></%block>
      </div>

      % if user.is_authenticated():
        <%include file="widgets/sock.html" args="online_help_token=online_help_token" />
      % endif
      <%include file="widgets/footer.html" />

      <div id="page-notification"></div>
    </div>

    <div id="page-prompt"></div>

    <%block name="modal_placeholder"></%block>

    <%block name="jsextra"></%block>
    <script type="text/javascript">
      require(['common/js/common_libraries'], function () {
          require(['js/factories/base'], function () {
            % if context_course:
              require(['js/factories/course'], function(CourseFactory) {
                  CourseFactory({
                      id: "${escape_js_string(context_course.id) | n}",
                      name: "${context_course.display_name_with_default | h}",
                      url_name: "${context_course.location.name | h}",
                      org: "${context_course.location.org | h}",
                      num: "${context_course.location.course | h}",
                      display_course_number: "${_(context_course.display_number_with_default)}",
                      revision: "${context_course.location.revision | h}",
                      self_paced: ${escape_json_dumps(context_course.self_paced) | n}
                  });
              });
            % endif
            % if user.is_authenticated():
                require(['js/sock']);
            % endif
            <%block name='requirejs'></%block>
          });
      });
    </script>
    <%include file="widgets/segment-io-footer.html" />
    <div class="modal-cover"></div>
    <script>
    window.intercomSettings = {
      % if user.is_authenticated():
        %if user.get_full_name():
          name: "${user.get_full_name() }", // Full name
        %endif
        email: "${user.email }", // Email address
        created_at: ${user.date_joined.strftime("%s")}, // Signup date as a Unix timestamp
        user_hash: "${ hmac.new('TEVGD2fA9Lzm9un_zN1AGcfWLJGvyH18sBbJtj2M', user.email, digestmod=hashlib.sha256).hexdigest() }",
        "organization": "${user.organizations.first() }",
      %endif
      app_id: "e4awi275"
    };
  </script>
  <script>(function(){var w=window;var ic=w.Intercom;if(typeof ic==="function"){ic('reattach_activator');ic('update',intercomSettings);}else{var d=document;var i=function(){i.c(arguments)};i.q=[];i.c=function(args){i.q.push(args)};w.Intercom=i;function l(){var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://widget.intercom.io/widget/e4awi275';var x=d.getElementsByTagName('script')[0];x.parentNode.insertBefore(s,x);}if(w.attachEvent){w.attachEvent('onload',l);}else{w.addEventListener('load',l,false);}}})()</script>
  </body>
</html>
